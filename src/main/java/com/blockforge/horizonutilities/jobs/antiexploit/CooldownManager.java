package com.blockforge.horizonutilities.jobs.antiexploit;

import com.blockforge.horizonutilities.jobs.JobAction;

import java.util.EnumMap;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Per-player, per-action cooldown tracker. All operations are thread-safe and
 * rely entirely on in-memory state (no persistence needed across restarts).
 */
public class CooldownManager {

    /** playerUuid -> (action -> last-action-timestamp) */
    private final Map<UUID, Map<JobAction, Long>> lastActionTime = new ConcurrentHashMap<>();

    /**
     * Returns {@code true} if the player is currently on cooldown for this
     * action type.
     *
     * @param playerUuid  player's UUID
     * @param action      the action type to check
     * @param cooldownMs  cooldown length in milliseconds (0 or negative disables)
     */
    public boolean isOnCooldown(UUID playerUuid, JobAction action, long cooldownMs) {
        if (cooldownMs <= 0) return false;
        Map<JobAction, Long> map = lastActionTime.get(playerUuid);
        if (map == null) return false;
        Long last = map.get(action);
        if (last == null) return false;
        return (System.currentTimeMillis() - last) < cooldownMs;
    }

    /**
     * Records that the player just performed this action, resetting their
     * cooldown timer.
     */
    public void recordAction(UUID playerUuid, JobAction action) {
        lastActionTime
                .computeIfAbsent(playerUuid, k -> new EnumMap<>(JobAction.class))
                .put(action, System.currentTimeMillis());
    }

    /**
     * Returns the remaining cooldown in milliseconds for the player's action,
     * or 0 if not on cooldown.
     */
    public long getRemainingMs(UUID playerUuid, JobAction action, long cooldownMs) {
        if (cooldownMs <= 0) return 0;
        Map<JobAction, Long> map = lastActionTime.get(playerUuid);
        if (map == null) return 0;
        Long last = map.get(action);
        if (last == null) return 0;
        long remaining = cooldownMs - (System.currentTimeMillis() - last);
        return Math.max(0, remaining);
    }

    /**
     * Removes all cooldown data for the player (call on logout to free memory).
     */
    public void cleanup(UUID playerUuid) {
        lastActionTime.remove(playerUuid);
    }
}
