package com.blockforge.horizonutilities.jobs.antiexploit;

import com.blockforge.horizonutilities.jobs.JobStorageManager;

import java.util.UUID;

/**
 * Provides a clean API for checking and enforcing per-job hourly income caps.
 * Delegates persistence to {@link JobStorageManager}.
 */
public class IncomeCapManager {

    private final JobStorageManager storage;

    public IncomeCapManager(JobStorageManager storage) {
        this.storage = storage;
    }

    // -------------------------------------------------------------------------
    // Public API
    // -------------------------------------------------------------------------

    /**
     * Returns how much the player has earned in the current clock-hour for the
     * given job.
     */
    public double getHourlyEarned(UUID playerUuid, String jobId) {
        return storage.getHourlyEarned(playerUuid, jobId);
    }

    /**
     * Returns {@code true} if the player can earn any more from this job in the
     * current hour (i.e. they have not yet reached the cap).
     *
     * @param cap a value of -1 means no cap is enforced
     */
    public boolean canEarn(UUID playerUuid, String jobId, double cap) {
        if (cap < 0) return true;
        return getHourlyEarned(playerUuid, jobId) < cap;
    }

    /**
     * Returns how much the player may still earn from this job in the current
     * hour. Returns {@code Double.MAX_VALUE} when no cap is set ({@code cap < 0}).
     */
    public double getRemainingCap(UUID playerUuid, String jobId, double cap) {
        if (cap < 0) return Double.MAX_VALUE;
        double earned = getHourlyEarned(playerUuid, jobId);
        return Math.max(0, cap - earned);
    }

    /**
     * Records that the player earned {@code amount} from this job, updating the
     * DB row for the current hour. Call AFTER a successful payment.
     */
    public void trackEarning(UUID playerUuid, String jobId, double amount) {
        if (amount <= 0) return;
        storage.trackIncome(playerUuid, jobId, amount);
    }
}
